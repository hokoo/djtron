# djTRON

djTRON - браузерный плеер для дискотек и музыкальных мероприятий с режимами `Host` (лайв) и `Slave` (удаленные клиенты). Не-live клиенты предназначены для предварительного прослушивания треков, формирования трек-листов и очереди воспроизведения на live.

## Что умеет сейчас

- Работает по локальной сети: один ПК запускает сервер, остальные подключаются через браузер.
- Разделяет роли:
  - `Host` - клиент на серверном ПК (локальный адрес), управляет live-воспроизведением.
  - `Slave` - удаленные клиенты, работают после авторизации.
- Синхронизирует плей-листы и их состояние между всеми клиентами в реальном времени (SSE).
- Поддерживает авто-плей-листы из папок внутри `audio/`.
- Поддерживает drag&drop с режимами `Move/Copy` и удаление треков через корзину.
- Поддерживает сохранение состояния плей-листов и сессий между перезапусками сервера.
- Показывает прогресс и тайминг текущего трека; на слейвах дополнительно отображается отдельный live-бар хоста.

## Быстрый старт

1. Установите Node.js 18+.
2. Скопируйте аудио в папку `audio/` (поддержка: `mp3`, `wav`, `ogg`, `m4a`, `flac`).
3. Создайте пользователей в папке `users/` (см. раздел «Авторизация»).
4. Запустите сервер:

```bash
npm start
```

По умолчанию приложение доступно на `http://localhost:3000`.

## Конфиг `extra.conf` и `localStorage`

В корне проекта можно создать текстовый файл `extra.conf`.
Файл полностью опционален: может отсутствовать, а любой параметр можно не указывать.
Шаблон: `extra.conf.example` (скопируйте его в `extra.conf`).

Поддерживаемые параметры:

- `port` - порт сервера (если `PORT` не задан через переменную окружения).
- `allow_context_menu` (или `context_menu`) - `true/false`; при `true` отключает блокировку контекстного меню.
- `volume_presets` - пользовательский набор пресетов громкости в процентах (`0-100` формат).
- `dsp_enabled` - `true/false`; включает локальную DSP-подготовку переходов.
- `dsp_ffmpeg_path` - путь к бинарнику `ffmpeg` (по умолчанию `ffmpeg` из `PATH`).
- `dsp_ffprobe_path` - путь к бинарнику `ffprobe` (по умолчанию `ffprobe` из `PATH`).
- `dsp_transition_output_format` - формат transition-файлов (`wav` или `mp3`), по умолчанию `wav` для более точных стыков.
- `dsp_transition_seconds` - длительность склейки по умолчанию.
- `dsp_slice_seconds` - длина хвоста/головы треков, используемых для сборки transition.
- `dsp_live_entry_compensation_ms` - компенсация старта transition на стыке `track -> transition` (мс).
- `dsp_live_exit_compensation_ms` - компенсация handoff на стыке `transition -> track` (мс).
- `dsp_tempo_align_enabled` - `true/false`; выравнивание темпа второго трека под первый.
- `dsp_tempo_max_adjust_percent` - предел авто-коррекции темпа (в процентах, симметрично).
- `dsp_tempo_glide_enabled` - `true/false`; плавно доводит темп target к `1.0` к концу transition.
- `dsp_tempo_glide_segments` - число сегментов для tempo-glide (обычно `3-6`).
- `dsp_tempo_glide_anchor_seconds` - "якорный" хвост transition без time-stretch перед стыком с оригинальным треком.
- `dsp_tempo_analysis_seconds` - длина фрагмента для BPM-анализа при отсутствии метаданных.
- `dsp_aggressive_join` - `true/false`; более резкая склейка (короче crossfade, более быстрый вход/выход).
- `dsp_join_intensity` - интенсивность агрессивной склейки (`0..1`).
- `dsp_trim_silence_enabled` - `true/false`; автообрезка тишины в хвосте первого и голове второго трека.
- `dsp_trim_silence_db` - порог тишины (dB) для обрезки.
- `dsp_trim_min_silence_seconds` - минимальная длина паузы, считающаяся тишиной.
- `dsp_trim_max_seconds` - максимум секунд обрезки на хвост/голову.
- `dsp_no_gap_guard` - `true/false`; дополнительный агрессивный trim-проход, чтобы убирать паузы между склеиваемыми битами.
- `dsp_trim_guard_threshold_boost_db` - насколько поднять порог dB в no-gap guard проходе.
- `dsp_no_gap_energy_trim` - `true/false`; энерго-анализ границ (вырезает не только тишину, но и очень тихие "безбитовые" участки).
- `dsp_no_gap_energy_floor_ratio` - доля от "сильного" уровня сигнала для порога energy-trim.
- `dsp_no_gap_energy_mean_multiplier` - множитель среднего уровня для порога energy-trim.
- `dsp_max_queue` - максимальный размер очереди DSP-задач.
- `dsp_log_max_bytes` - ограничение размера `dsp.log` перед ротацией в `dsp.log.prev`.

Пример:

```conf
port=3010
allow_context_menu=true
volume_presets=15,35,60
dsp_enabled=true
dsp_transition_output_format=wav
dsp_transition_seconds=5
dsp_slice_seconds=15
dsp_live_entry_compensation_ms=22
dsp_live_exit_compensation_ms=19
dsp_tempo_align_enabled=true
dsp_tempo_max_adjust_percent=12
dsp_tempo_glide_enabled=true
dsp_tempo_glide_segments=4
dsp_tempo_glide_anchor_seconds=0.22
dsp_aggressive_join=true
dsp_join_intensity=0.78
dsp_trim_silence_enabled=true
dsp_trim_silence_db=-36
dsp_trim_max_seconds=4.8
dsp_no_gap_guard=true
dsp_trim_guard_threshold_boost_db=10
dsp_no_gap_energy_trim=true
dsp_no_gap_energy_floor_ratio=0.18
dsp_no_gap_energy_mean_multiplier=1.7
```

Схема уровней переопределения (`override-scope`):

- `none` - только серверное значение (`extra.conf`/ENV), `localStorage` игнорируется.
- `client` - локальное переопределение разрешено на любом клиенте.
- `host` - локальное переопределение разрешено только на клиенте роли Host.

Текущие правила:

- `port` -> `none` (не читается из `localStorage` вообще).
- `allow_context_menu` -> `client` (`djtron:config:allowContextMenu`).
- `volume_presets` -> `host` (`djtron:config:volumePresets`).
- `dsp_live_entry_compensation_ms` -> `none`.
- `dsp_live_exit_compensation_ms` -> `none`.

Если ключа нет в разрешенном уровне `localStorage`, используется серверное значение из `extra.conf`.

## LAN-подключение (Windows 10/11)

1. Запустите сервер на основном ПК.
2. Узнайте его IP через `ipconfig`.
3. На другом ПК откройте `http://<IP_СЕРВЕРА>:<PORT>`.
4. Разрешите входящие подключения на выбранный TCP-порт в Windows Firewall.

## Авторизация

- Локальный клиент серверного ПК (Host) входит без логина/пароля.
- Удаленные клиенты (Slave) должны авторизоваться.
- Сессия хранится в cookie и сохраняется после перезапуска сервера.
- Время жизни сессии: 12 часов.
- Данные сессий сохраняются в `sessions-state.json`.

Формат учеток:

- Папка: `users/`
- Один файл = один пользователь
- Имя файла = логин (`dj`, `dj.txt`, `operator.txt` и т.п.)
- Первая непустая строка файла = пароль

Пример:

```text
users/operator.txt
myStrongPassword123
```

## Плей-листы и треки

- Количество плей-листов не ограничено.
- Плей-листы можно добавлять, переименовывать и удалять (с ограничениями).
- Авто-плей-листы создаются из подпапок в `audio/` автоматически.
- У авто-плейлистов показывается иконка папки, а в `hint` у иконки хранится исходное имя папки.
- Для каждого трека можно переключать отображаемое имя:
  - имя файла;
  - атрибуты файла (если доступны).
- Режим имени трека переключается кликом по индексу трека и синхронизируется между клиентами.

## Правила drag&drop

- Обычный drag - перемещение.
- `Ctrl`/`Cmd` + drag - копирование.
- На тач-устройствах long touch активирует режим копирования.
- В процессе drag показывается метка режима (`Move`/`Copy`/`Delete`/`Cancel`).
- Активный трек нельзя перемещать или копировать.
- Для треков из авто-плейлиста папки:
  - внутри своего плей-листа можно `move` и `copy`;
  - перенос в другой плей-лист всегда становится `copy`.

## Удаление треков и плей-листов

- Удаление треков выполняется только через перетаскивание в корзину.
- Трек можно удалить из плей-листа только если где-то есть еще его копия.
- Неудаляемые треки визуально помечаются как заблокированные.
- Плей-лист можно удалить только если:
  - он пустой;
  - или каждый его трек есть хотя бы в одном другом плей-листе.
- Нельзя удалить:
  - последний оставшийся плей-лист;
  - авто-плейлист папки, пока папка существует в `audio/`;
  - плей-лист, который сейчас играет на live.

## Воспроизведение и роли

- Host управляет live-воспроизведением и может останавливать сервер.
- Slave не может останавливать сервер.
- Автовоспроизведение (`A`) настраивается только хостом.
- На слейвах `A` отображается, но не редактируется.
- На слейвах показываются два верхних бара:
  - `Live` (состояние хоста, без управления);
  - локальный бар клиента (с управлением и seek).
- Если live-трек есть в нескольких плей-листах, подсветка идет только в том плей-листе, откуда он запущен.

## Обновление медиатеки

- djTRON автоматически отслеживает изменения в `audio/` (новые файлы/папки).
- Есть кнопка `Обновить` для ручного пересканирования медиатеки без перезагрузки страницы.

## Локальный DSP (MVP)

- Используется один сервер Node.js: отдельный HTTP-сервис не требуется.
- DSP-переходы рендерятся локально через `ffmpeg` в фоне и кэшируются на диске:
  - каталог кэша: `.cache/dsp/transitions/`.
- По умолчанию transitions сохраняются в `wav` (точнее на стыках, меньше микросдвигов, чем при mp3-пере-кодировании).
- Для переходов включено выравнивание темпа (BPM) второго трека под первый через `rubberband` (с ограничением по проценту изменения).
- Темп второго трека в переходе можно плавно доводить до нативного значения (`dsp_tempo_glide_enabled`, `dsp_tempo_glide_segments`).
- Включен агрессивный режим склейки: автообрезка тишины в конце/начале и более интенсивный crossfade.
- Дополнительно работает no-gap guard, который делает второй trim-проход с более высоким порогом, чтобы убрать «провалы» между битами.
- Очередь автоматически подготавливает переходы между соседними треками в каждом плей-листе:
  - при старте сервера;
  - после каждого изменения layout.
- В тестовом режиме при запуске трека host дополнительно ставит в очередь пару
  `текущий -> следующий` (в том же плей-листе) с высоким приоритетом.
- API:
  - `GET /api/dsp/transitions` - список задач и состояние очереди.
  - `GET /api/dsp/transitions?from=<track>&to=<track>` - статус конкретной пары.
  - `POST /api/dsp/transitions` - ручная постановка задач (только Host).
  - `GET /api/dsp/transitions/file/<id>` - доступ к готовому transition-файлу.
- Логи DSP пишутся в файл `dsp.log` в корне проекта (кратко: enqueue/start/ready/failed).
- Для работы нужен установленный `ffmpeg`. Если его нет, задачи переходят в `failed` с причиной ошибки.

## Сохранение состояния

- `layout-state.json` - раскладка треков по плей-листам, имена плей-листов, метаданные, флаги autoplay, режимы названий треков.
- `sessions-state.json` - активные сессии авторизации.
- `update-state.json` - кэш информации о проверке обновлений приложения.

## Быстрые скрипты запуска

- Windows: `run-player.bat`
- macOS: `run-player.command`
- Оба скрипта открывают браузер на порту из `PORT`, иначе из `extra.conf`, иначе `3000`.

Если `run-player.command` не запускается, дайте права:

```bash
chmod +x run-player.command
```
